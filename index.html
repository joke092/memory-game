<!doctype html>

<html lang="pl">
<head>
    <meta charset="utf-8">
    <title> Memory </title>
    <link rel="shortcut icon" href="favicon.ico">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;">
    <link rel="stylesheet" href="./dist/css/style.css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <script src="dist/js/out.js"></script>
</head>
<body>
<span class="loading"></span>

<!-- plansza menu poczatkowego -->
<div class="slide-start" id="stageStart">
    <div class="start-menu">
        <a href="#slideGame" class="start-game button" id="startGame">Start</a>
        <a href="#slideHighscore" class="show-highscore button" id="showHighscore">Pokaż wyniki</a>
    </div>
</div>

<!-- plansza z pobieraniem nazwy gracza -->
<div class="slide-player-name" id="stagePlayerName">
    <div class="player-name-box">
        <label for="playerName">Nazwa gracza:</label>
        <input type="text" id="playerName" class="player-name" maxlength="10" />
        <div class="player-name-error">Musisz wpisać nazwę gracza</div>
        <button class="check-name button" id="checkName">Rozpocznij grę</button>
    </div>
</div>

<!-- plansza z gra -->
<div class="slide-game" id="stageGame">
    <div class="game-board" id="gameBoard"></div>
    <div class="game-moves-box">
        <strong>Liczba ruchów:</strong>
        <div class="game-moves" id="gameMoves"></div>
    </div>
</div>

<!-- tabela z wynikami -->
<div class="slide-highscore" id="stageHighscore">
    <h3>Wyniki gry</h3>
    <div class="highscore-board" id="highscoreBoard"></div>
    <a href="" class="close-highscore button">Zamknij</a>
</div>

<?php
$fileSrc = 'highscore.dat';
$resultsMaxCount = 10;
$action = (string)$_POST['action'];

if ($action == 'read') {
    $scoreBoard = readHighScore();
    echo json_encode($scoreBoard);
}
if ($action == 'save') {
    $player = (string)$_POST['player'];
    $playerMoves = (int)$_POST['moves'];
    saveHighScore($player, $playerMoves);
}

#=========================================
    function sortByScoreMaxToMin($a, $b) {
        if ($a['moves'] == $b['moves']) {
            return 0;
        }
        return ($a['moves'] < $b['moves'])? -1 : 1;
    }

    function saveHighScore($playerName, $playerMoves) {
        global $resultsMaxCount;
        global $fileSrc;

        $arrayTemp = Array(
            'player' => $playerName,
'moves' => $playerMoves
);

$scoreBoard = readHighScore();

array_push($scoreBoard, $arrayTemp);

$length = min(count($scoreBoard), $resultsMaxCount);
usort($scoreBoard, 'sortByScoreMaxToMin');

$newScoreBoard = array_slice($scoreBoard, 0, $length);

$fp = fopen($fileSrc, 'w');
flock($fp, LOCK_EX);
foreach ($newScoreBoard as $record) {
fwrite($fp, $record['player']."\r\n");
fwrite($fp, $record['moves']."\r\n");
}
fclose($fp);
}

function readHighScore() {
global $fileSrc;

//pobieramy plik do tablicy
$fileLines = file($fileSrc);

$highScore = Array();

//robimy pętlę po liniach pliku i wrzucamy je do talbicy $highScore
//każdy wynik zapisany jest w 2 liniach. Dlatego x za każdym razem zwiększamy o 2
if (count($fileLines) > 1) {
$i = 0;
for ($x=0; $x<count($fileLines); $x+=2) {
$highScore[$i] = Array(
'player' => trim($fileLines[$x]),
'moves' => trim($fileLines[$x+1])
);
$i++;
}
}
return $highScore;
}
#=========================================
?>
</body>
</html>